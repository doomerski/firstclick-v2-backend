# FirstClick API - Nginx HTTP-level Configuration
#
# This file contains directives that MUST be in the http {} context.
# Place in /etc/nginx/conf.d/ (auto-included by nginx.conf)
#
# Installation:
#   sudo cp firstclick-common.conf /etc/nginx/conf.d/
#   sudo nginx -t
#   sudo systemctl reload nginx

# Rate limiting zone (10 requests/second per IP, 10MB zone)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_status 429;

# WebSocket connection upgrade map
# This ensures Connection header is set correctly:
#   - "upgrade" when client requests WebSocket upgrade
#   - "close" for normal HTTP requests
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}
