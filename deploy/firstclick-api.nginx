# FirstClick API - Nginx Reverse Proxy Configuration
#
# This file contains ONLY server/upstream blocks (no http-level directives).
# The http-level config (rate limit zone, websocket map) is in firstclick-common.conf.
#
# Installation:
#   1. Copy http-level config:
#      sudo cp firstclick-common.conf /etc/nginx/conf.d/
#
#   2. Copy site config:
#      sudo cp firstclick-api.nginx /etc/nginx/sites-available/firstclick-api
#      sudo ln -sf /etc/nginx/sites-available/firstclick-api /etc/nginx/sites-enabled/
#
#   3. Test and reload:
#      sudo nginx -t
#      sudo systemctl reload nginx
#
# SSL (after DNS is configured):
#   sudo apt install certbot python3-certbot-nginx -y
#   sudo certbot --nginx -d api.firstclick.it.com

# Upstream for load balancing (single instance for now)
upstream firstclick_api {
    server 127.0.0.1:3000;
    keepalive 32;
}

server {
    listen 80;
    listen [::]:80;
    server_name api.firstclick.it.com;

    # Logging
    access_log /var/log/nginx/firstclick-api.access.log;
    error_log /var/log/nginx/firstclick-api.error.log;

    # Max request body size (matches Express body-parser limit of 1MB)
    client_max_body_size 1m;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Health check endpoint (exempt from rate limiting, no access log)
    location = /health {
        proxy_pass http://firstclick_api;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log off;
    }

    # API routes
    location / {
        # Rate limiting (uses zone from firstclick-common.conf)
        # Uncomment to enable nginx-level rate limiting:
        # limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://firstclick_api;
        proxy_http_version 1.1;

        # WebSocket support (uses map from firstclick-common.conf)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Forward client info to Express (required for trust proxy)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Upstream error handling
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    # Block access to hidden files (dotfiles)
    location ~ /\. {
        deny all;
        return 404;
    }

    # Block access to sensitive files (belt-and-suspenders with Node)
    location ~* ^/(?:\.env|package\.json|package-lock\.json|pnpm-lock\.yaml|yarn\.lock|node_modules) {
        deny all;
        return 404;
    }
}

# HTTPS server block (auto-generated by certbot, or copy blocks above after manual setup)
